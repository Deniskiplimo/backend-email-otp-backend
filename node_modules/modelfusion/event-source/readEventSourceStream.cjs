"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.readEventSourceStream = void 0;
const parseJSON_js_1 = require("../util/parseJSON.cjs");
const AsyncQueue_js_1 = require("./AsyncQueue.cjs");
const parseEventSourceStream_js_1 = require("./parseEventSourceStream.cjs");
function readEventSourceStream({ stream, schema, errorHandler, }) {
    const queue = new AsyncQueue_js_1.AsyncQueue();
    // run async (no await on purpose):
    (0, parseEventSourceStream_js_1.parseEventSourceStream)({ stream })
        .then(async (events) => {
        try {
            for await (const event of events) {
                const validationResult = (0, parseJSON_js_1.safeParseJsonWithSchema)(event.data, schema);
                if (!validationResult.success) {
                    errorHandler?.(validationResult.error);
                    continue;
                }
                queue.push(validationResult.data);
            }
        }
        catch (error) {
            errorHandler?.(error);
        }
        finally {
            queue.close();
        }
    })
        .catch((error) => {
        errorHandler?.(error);
        queue.close();
    });
    return queue;
}
exports.readEventSourceStream = readEventSourceStream;
